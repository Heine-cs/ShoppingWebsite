@model IEnumerable<OllieShop.ViewModels.VMProductWithSpecification>
@{
    var productPlusSpec = @Model.FirstOrDefault();
    ViewData["Title"] = "商品【" + @productPlusSpec.Name + "】頁面";
}
<style>
    #ImgContainer{
        height:730px;
    }
    #ImgContainer >img:first-child{
        width:100%;
        height: 100%;
        object-fit:contain;
    }
    i{
        cursor:pointer;
    }
    /*隱藏input欄位的增減鍵*/
    /* Chrome, Safari, Edge, Opera */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Firefox */
    input[type=number] {
        -moz-appearance: textfield;
    }
</style>

<div class="container-fluid row p-1">
    <div class="col align-self-center" id="ImgContainer">
        <img src="@productPlusSpec.Picture" />
    </div>

    @{
        //資料顯示格式處理
        string Inquired = productPlusSpec.Inquired == true ? "開放詢價" : "不開放詢價";
        string Unopened = productPlusSpec.Unopened == true ? "全新品" : "二手品";
        string Installment = productPlusSpec.Installment == true ? "開放分期" : "不開放分期";
        int RestQuantity  = productPlusSpec.ShelfQuantity - productPlusSpec.SoldQuantity;
    }

    <div class="col mt-1 d-flex flex-column">
        <div class="flex-grow-1">
            <h1><strong>@productPlusSpec.Name</strong></h1>
            <div>商品狀況 : @Unopened</div>
            <div>商品數量 : @(RestQuantity)件</div>
            <div>備貨日 : @(productPlusSpec.LeadDay)個工作天</div>
            <div>運費 : NT$@productPlusSpec.DeliveryFee.ToString("0")</div>
            <div>詢價許可 : @Inquired</div>
            <div>分期許可 : @Installment</div>
            <div>商品贈品 : @productPlusSpec.Freebie</div>
            <div>體積 : @productPlusSpec.Size cm³</div>
            <div>商品重量 : @productPlusSpec.Weight 公斤</div>
            <div>商品描述 : @productPlusSpec.Description</div>
        </div>

        <div class="row flex-grow-0">
            <h2 class="col-4 align-self-center">售價 : NT$ @productPlusSpec.UnitPrice.ToString("0")</h2>
            <div class="col-8 d-flex justify-content-end mb-2">
                <i class="bi bi-plus-circle fs-1 me-3 text-primary" onclick="ProductQuantityChange(1)"></i>
                <i class="bi bi-dash-circle fs-1 me-3 text-secondary" onclick="ProductQuantityChange(-1)"></i>
                <input id="InputQuantity" class="form-control w-25" type="number" min="1" value="1" oninput="InputvalidateAndClear();validity.valid||(value=1);" /><span class="fs-1 me-2">個</span>
                <div class="btn btn-outline-primary btn-lg" onclick="saveProductToCart()">
                    加入購物車
                    <i class="ms-1 bi bi-cart4 fs-4"></i>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    
    function ProductQuantityChange(QuantityChangeValue) {
        let InputQuantity = document.getElementById("InputQuantity");
        let IntInputQuantity = parseInt(InputQuantity.value);
        if (IntInputQuantity === 1 && QuantityChangeValue === -1){
            return "";
        }
        IntInputQuantity += QuantityChangeValue;
        if (IntInputQuantity > @RestQuantity) {
            return ""; 
        }
        InputQuantity.value = IntInputQuantity;
    }

    function InputvalidateAndClear() {
        
        let inputElement = document.getElementById("InputQuantity");
        let inputValue = inputElement.value;
        // 執行驗證邏輯
        if (inputValue > @RestQuantity || inputValue === 0) {
            // 驗證失敗，清除輸入
            inputElement.value = 1;
        }
    }

    function saveProductToCart() {
        // 取得當前存在 localStorage 的商品資料
        let cartData = localStorage.getItem('cartData');
        let newCartData = [];
        let InputQuantity = Number(document.getElementById("InputQuantity").value);
        if (cartData !== null) {
            // 轉回陣列放入 newCartData 陣列
            newCartData = JSON.parse(cartData);
            newCartData[0].push(@Model.FirstOrDefault().PTID);
            newCartData[1].push(@Model.FirstOrDefault().SNID);
            newCartData[2].push(InputQuantity);
        }
        else {
            // 初始化 productID 、specificationsID 、 inputQuantity
            let productID = [];
            let specificationsID = [];
            let inputQuantityArr = [];

            // PTID 放在第一個陣列
            productID.push(@Model.FirstOrDefault().PTID);
            newCartData.push(productID);
            
            // SNID 放在第二個陣列
            specificationsID.push(@Model.FirstOrDefault().SNID);
            newCartData.push(specificationsID);

            // InputQuantity 放在第三個陣列
            inputQuantityArr.push(InputQuantity);
            newCartData.push(inputQuantityArr);
        }
        // 存储到 localStorage
        localStorage.setItem('cartData', JSON.stringify(newCartData));

        //提示用戶存入購物車操作成功
        alert('成功將商品加入購物車!!');
    }
</script>